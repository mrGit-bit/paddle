<!-- absolute path: /workspaces/paddle/paddle/frontend/templates/frontend/match.html --> 

{% extends 'frontend/base.html' %}
{% load static %}

{% block title %}Partidos{% endblock %}

{% block content %}
<!-- Title Section -->
<div class="text-center mb-4">
  <h1 class="display-4">üèìPartidosüèì</h1>    
</div>


<div class="container">
<!-- Display success or error messages -->
  {% if messages %}
  <div class="row justify-content-center">
    <div class="col-lg-8"> <!-- Match form width -->
    {% for message in messages %}
      <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% endif %}" role="alert">
        {{ message|linebreaksbr }}
      </div>    
    {% endfor %}
    </div>
  </div>
  {% endif %}
  
  
  <!-- Add New Match or Edit Section -->
  <div class="row justify-content-center mb-5">    
    <div class="col-lg-8">
      <form id="add-edit-match-form" method="POST" action="" autocomplete="off" class="card p-4 shadow">
        {% csrf_token %}
        <h4 class="text-center mb-2">Nuevo Resultado</h4>
        <div class="row">
          
          <!-- Team 1 Card -->
          <div class="col-sm-6 mb-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Pareja 1Ô∏è‚É£</h5>
                
                <!-- Team 1 Player 1 shall be the current user-->
                <div class="mb-3 form-floating">
                  <input
                  type="text"
                  class="form-control"
                  id="team1_player1"
                  name="team1_player1"
                  value="{{ user.username }}"                  
                  readonly
                  disabled                  
                  />
                  <label for="team1_player1" class="form-label">T√∫‚úÖ</label>
                </div>
                
                <!-- Team 1 Player 2 options from the player list or new one-->
                <div class="mb-3">
                  <div class="form-floating">
                    <select class="form-select player-select"
                      id="team1_player2_choice"
                      name="team1_player2_choice"
                      required>
                      <option value="" selected>Selecciona jugador</option>
                      {% for player in all_players %}
                        <option value="{{ player.id }}">{{ player.name }}</option>
                      {% endfor %}
                      <option value="NEW_M">‚ûï Nuevo jugador (Hombre)</option>
                      <option value="NEW_F">‚ûï Nueva jugadora (Mujer)</option>
                    </select>
                    <label for="team1_player2_choice" class="form-label">Jugador*</label>
                  </div>

                  <div class="form-floating mt-2 d-none new-player-wrapper" id="team1_player2_new_wrapper">
                    <input
                      type="text"
                      class="form-control new-player-name"
                      id="team1_player2_new_name"
                      name="team1_player2_new_name"
                      placeholder="Nombre del nuevo jugador"
                      autocomplete="off"
                    />
                    <label for="team1_player2_new_name">Nombre (nuevo jugador)*</label>
                    <div class="form-text" id="team1_player2_new_hint"></div>
                  </div>
                </div>
                
                <!-- Winner Team 1 Radio Button -->
                <div class="form-check">
                  <input
                  class="form-check-input"
                  type="radio"
                  name="winning_team"
                  id="team1_wins"
                  value="1"
                  required
                  />
                  <label class="form-check-label" for="team1_wins">üèÜ Ganadores</label>
                </div>
              </div>
            </div>
          </div>
          <!-- Team 2 Card -->
          <div class="col-sm-6">
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">Pareja 2Ô∏è‚É£</h5>
                <!-- Team 2 Player 1 choose from the player list or new one-->
                <div class="mb-3">
                  <div class="form-floating">
                    <select class="form-select player-select"
                      id="team2_player1_choice"
                      name="team2_player1_choice"
                      required>
                      <option value="" selected>Selecciona jugador</option>
                      {% for player in all_players %}
                        <option value="{{ player.id }}">{{ player.name }}</option>
                      {% endfor %}
                      <option value="NEW_M">‚ûï Nuevo jugador (Hombre)</option>
                      <option value="NEW_F">‚ûï Nueva jugadora (Mujer)</option>
                    </select>
                    <label for="team2_player1_choice" class="form-label">Jugador*</label>
                  </div>

                  <div class="form-floating mt-2 d-none new-player-wrapper" id="team2_player1_new_wrapper">
                    <input
                      type="text"
                      class="form-control new-player-name"
                      id="team2_player1_new_name"
                      name="team2_player1_new_name"
                      placeholder="Nombre del nuevo jugador"
                      autocomplete="off"
                    />
                    <label for="team2_player1_new_name">Nombre (nuevo jugador)*</label>
                    <div class="form-text" id="team2_player1_new_hint"></div>
                  </div>
                </div>

                <!-- Team 2 Player 2 choose from the player list or new one-->
                <div class="mb-3">
                  <div class="form-floating">
                    <select class="form-select player-select"
                      id="team2_player2_choice"
                      name="team2_player2_choice"
                      required>
                      <option value="" selected>Selecciona jugador</option>
                      {% for player in all_players %}
                        <option value="{{ player.id }}">{{ player.name }}</option>
                      {% endfor %}
                      <option value="NEW_M">‚ûï Nuevo jugador (Hombre)</option>
                      <option value="NEW_F">‚ûï Nueva jugadora (Mujer)</option>
                    </select>
                    <label for="team2_player2_choice" class="form-label">Jugador*</label>
                  </div>

                  <div class="form-floating mt-2 d-none new-player-wrapper" id="team2_player2_new_wrapper">
                    <input
                      type="text"
                      class="form-control new-player-name"
                      id="team2_player2_new_name"
                      name="team2_player2_new_name"
                      placeholder="Nombre del nuevo jugador"
                      autocomplete="off"
                    />
                    <label for="team2_player2_new_name">Nombre (nuevo jugador)*</label>
                    <div class="form-text" id="team2_player2_new_hint"></div>
                  </div>
                </div>

                <!-- Winner Radio Button -->
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="winning_team"
                    id="team2_wins"
                    value="2"
                    />
                  <label class="form-check-label" for="team2_wins">üèÜ Ganadores</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {% comment %} <!-- Datalist options for Players input fields-->
        <datalist id="players">
          {% for player in all_players %}
          <option value="{{ player.name }}">{{ player.name }}</option>
          {% endfor %}
        </datalist> {% endcomment %}
        
        <!-- Date and Submit Button -->
        <div class="d-flex justify-content-between mt-3">
          <!-- Date Picker limited to today (max must be in ISO format)-->
          <div>
            <label for="date_played" class="form-label">Fecha del partido:</label>
            <input
            type="date"
            class="form-control"
            id="date_played"
            name="date_played"            
            max="{{ today }}"
            required
            />
          </div>
          <!-- Submit Button -->
          <button type="submit" class="btn btn-success"> Agregar </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- List of Matches Section -->
  <h4 class="mb-4" id="match-history">Partidos jugados</h4>

  <!-- Match History Tabs -->
  <ul class="nav nav-tabs mb-3" id="matchTabs">
    <li class="nav-item">
      <a class="nav-link active" id="user-matches-tab" data-bs-toggle="tab" href="#user-matches">Mis partidos</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="all-matches-tab" data-bs-toggle="tab" href="#all-matches">Todos</a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- My Matches Tab -->
    <div class="tab-pane fade show active" id="user-matches">
      <div class="row">
        {% for match in user_matches %} <!-- Loop only through user matches -->
          {% include "frontend/_match_card.html" with match=match %}
        {% empty %}
          <p class="text-center">Sin partidos</p>
        {% endfor %}
      </div>
      
      <!-- Pagination for user matches -->
      <div id="user-pagination" data-pagination="user" style="display: none;">
        {% include "frontend/_pagination.html" with pagination=user_pagination anchor="#user-matches" %}
      </div>
      
    </div>
    
    <!-- All Matches Tab -->
    <div class="tab-pane fade" id="all-matches">
      <div class="row">
        {% for match in matches %} <!-- Loop through all matches -->
          {% include "frontend/_match_card.html" with match=match %}
          {% empty %}
          <p class="text-center">Sin partidos</p>
          {% endfor %}
        </div>
      </div>
      
      <!-- Pagination for all matches -->
      <div id="all-pagination" data-pagination="all" style="display: none;">
        {% include "frontend/_pagination.html" with pagination=pagination anchor="#all-matches" %}
      </div>
      
    </div>

  </div>
</div>


{% endblock %}

<!-- Block for additional scripts -->
{% block scripts %}
  <!-- Toggle New Name -->
  <script>
    (function () {
      function toggleNewName(selectEl) {
        const baseId = selectEl.id.replace("_choice", "");
        const wrapper = document.getElementById(baseId + "_new_wrapper");
        const input = document.getElementById(baseId + "_new_name");

        if (!wrapper || !input) return;

        const isNew = (selectEl.value === "NEW_M" || selectEl.value === "NEW_F");
        wrapper.classList.toggle("d-none", !isNew);

        if (isNew) {
          input.setAttribute("required", "required");
        } else {
          input.removeAttribute("required");
          input.value = "";
          // leave hint clearing to the updater script (Step 3C), but keep it clean:
          const hint = document.getElementById(baseId + "_new_hint");
          if (hint) hint.textContent = "";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("select.player-select").forEach(function (sel) {
          sel.addEventListener("change", function () { toggleNewName(sel); });
          toggleNewName(sel); // initial
        });
      });
    })();
  </script>

  <!-- Generate data for the Javascript playerLabelUpdater.js -->
  <script>
    // Dynamically generate player sets from Django
    // Exposed to window for external JS)
    window.registeredPlayers = new Set([
      {% for player in registered_players %}
        "{{ player.name }}",
      {% endfor %}
    ]);
    window.existingPlayers = new Set([
      {% for player in existing_players %}
        "{{ player.name }}",
      {% endfor %}
    ]);
  </script>
  <!-- Load JavaScript to update players input labels -->
  <script src="{% static 'frontend/js/playerLabelUpdater.js' %}"></script>

  <!-- Load JavaScript to highlight winning team card in the form-->
  <script src="{% static 'frontend/js/winningTeamHighlight.js' %}"></script>

  <!-- Load JavaScript to highlight match card when pressed delete button --> 
  <script src="{% static 'frontend/js/matchDeleteHighlight.js' %}"></script>  

  <!-- Load JavaScript to show only active tab pagination -->
  <script src="{% static 'frontend/js/tabPaginationReset.js' %}"></script>
  

{% endblock %}