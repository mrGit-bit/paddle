{% extends "frontend/base.html" %}
{% block title %}{{ tournament.name }}{% endblock %}

{% block content %}

{% if request.session.americano_round_error %}
  <div class="alert alert-danger">
    {{ request.session.americano_round_error }}
  </div>
{% endif %}

<div class="container py-1">

<!-- Tournament details header -->
  <div class="americano-title-row">
    <h1 class="mb-0 americano-title">{{ tournament.name }}</h1>
    
    {% comment %} {% if can_edit %}
      <span class="badge bg-warning text-dark">Jugador</span>
    {% endif %} {% endcomment %}

    {% if tournament.is_open_for_edit %}
      <span class="badge bg-success">En juego</span>
    {% else %}
      <span class="badge bg-secondary">Finalizado</span>
    {% endif %}

  </div>

  <small class="text-muted d-block americano-details">
    {% if tournament.created_by %}por {{ tournament.created_by }} ¬∑ {% endif %}
    {{ tournament.play_date }} ¬∑ {{ tournament.players.count }} jugadores
  </small>

  <!-- HoF-style classification table -->
  <div class="table-responsive mt-3">
    <table class="table table-striped table-hover">
      <colgroup>
        <col style="width: 12%;">
        <col style="width: 38%;">
        <col style="width: 12%;">
        <col style="width: 13%;">
        <col style="width: 13%;">
        <col style="width: 12%;">
      </colgroup>
      <thead>
        <tr>
          <th scope="col" class="text-center">ü•á</th>
          <th scope="col">Jugador</th>
          <th scope="col" class="text-center">üèÜ</th>
          <th scope="col" class="text-center">‚ûï</th>
          <th scope="col" class="text-center">‚ûñ</th>
          <th scope="col" class="text-center">üíé</th>
        </tr>
      </thead>
      <tbody>
        {% for row in standings %}
          <tr>
            <td class="text-center">{% if row.show_position %}{{ row.display_position }}{% else %}&nbsp;{% endif %}</td>
            <td>{{ row.player.name }}</td>
            <td class="text-center">{{ row.wins }}</td>
            <td class="text-center">{{ row.points_for }}</td>
            <td class="text-center">{{ row.points_against }}</td>
            <td class="text-center">{{ row.points_diff }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6" class="text-muted">Sin resultados todav√≠a.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Rounds below (completed first, current/next at end ) --> 

  {% for round in rounds %}
  <h3 class="h5 mt-3">Ronda {{ round.number }}</h3>

  <!-- Match assignment form only visible to can_edit users -->
  {% if can_edit %}
    <form method="post" action="{% url 'americano_assign_round' round.id %}">
      {% csrf_token %}
  {% endif %}

  <table class="table table-sm table-striped">
    <thead>
      <tr>
        <th class="text-center" style="width: 20%;">Pista</th>
        <th style="width: 40%;">Equipo 1</th>
        <th style="width: 40%;">Equipo 2</th>
      </tr>
    </thead>

    <tbody>
      {% for match in round.sorted_matches %}
        <tr>
          <!-- Pista -->
          <td class="text-center">
            {% if can_edit %}
              <select class="form-select form-select-sm"
                      name="match_{{ match.id }}_court">
                <option value="" {% if not match.court_number %}selected{% endif %}>n¬∫</option>

                {% for n in "123456789"|make_list %}
                  <option value="{{ forloop.counter }}"
                    {% if match.court_number == forloop.counter %}selected{% endif %}>
                    {{ forloop.counter }}
                  </option>
                {% endfor %}
              </select>
              <button type="submit"
                      class="btn btn-americano-header w-100 mt-2 americano-save-tall">
                Guardar
              </button>
              
            {% else %}
              <select class="form-select form-select-sm" disabled>
                <option selected>{{ match.court_number }}</option>
              </select>
            {% endif %}
          </td>

          <!-- Equipo 1 -->
          <td>
            <div class="mb-2">
              <select class="form-select form-select-sm"
                      {% if not can_edit %}disabled{% endif %}
                      name="match_{{ match.id }}_t1p1">
                <option value="">-- jugador 1 --</option>
                {% for p in tournament.players.all|dictsort:"name" %}
                  <option value="{{ p.id }}"
                    {% if match.team1_player1 and match.team1_player1.id == p.id %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <select class="form-select form-select-sm"
                      {% if not can_edit %}disabled{% endif %}
                      name="match_{{ match.id }}_t1p2">
                <option value="">-- jugador 2 --</option>
                {% for p in tournament.players.all|dictsort:"name" %}
                  <option value="{{ p.id }}"
                    {% if match.team1_player2 and match.team1_player2.id == p.id %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div>
              <input type="number"
                    class="form-control form-control-sm"
                    {% if not can_edit %}disabled{% endif %}
                    name="match_{{ match.id }}_score1"
                    placeholder="Puntos equipo 1"
                    value="{{ match.team1_points|default_if_none:'' }}">
            </div>
          </td>

          <!-- Equipo 2 -->
          <td>
            <div class="mb-2">
              <select class="form-select form-select-sm"
                      {% if not can_edit %}disabled{% endif %}
                      name="match_{{ match.id }}_t2p1">
                <option value="">-- jugador 1 --</option>
                {% for p in tournament.players.all|dictsort:"name" %}
                  <option value="{{ p.id }}"
                    {% if match.team2_player1 and match.team2_player1.id == p.id %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <select class="form-select form-select-sm"
                      {% if not can_edit %}disabled{% endif %}
                      name="match_{{ match.id }}_t2p2">
                <option value="">-- jugador 2 --</option>
                {% for p in tournament.players.all|dictsort:"name" %}
                  <option value="{{ p.id }}"
                    {% if match.team2_player2 and match.team2_player2.id == p.id %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div>
              <input type="number"
                    class="form-control form-control-sm"
                    {% if not can_edit %}disabled{% endif %}
                    name="match_{{ match.id }}_score2"
                    placeholder="Puntos equipo 2"
                    value="{{ match.team2_points|default_if_none:'' }}">
            </div>
          </td>
        </tr>

        <!-- Divider line between matches in the same round -->
        {% if not forloop.last %}
          <tr class="americano-match-divider">
            <td colspan="3"></td>
          </tr>
        {% endif %}

      {% endfor %}
    </tbody>
  </table>

  {% if can_edit %}
    </form>
  {% endif %}

  <!-- Action buttons row under last round -->
  {% if can_edit and forloop.last %}
    <div class="mt-2 d-flex gap-2 flex-wrap">
      
      <!-- New round button -->
      <a class="btn btn-sm btn-americano-header"
        href="{% url 'americano_new_round' tournament.pk %}">
        Nueva ronda
      </a>

      <!-- Delete round button -->
      <form method="post" action="{% url 'americano_delete_round' round.id %}" class="m-0">
        {% csrf_token %}
        <button type="submit"
                class="btn btn-sm btn-outline-danger"
                onclick="return confirm('¬øSeguro que quieres borrar la Ronda {{ round.number }}? Esta acci√≥n no se puede deshacer.');">
          Borrar ronda
        </button>
      </form>

      <!-- Delete tournament button -->
      {% if request.user.is_staff or tournament.created_by_id == request.user.id %}
        <form method="post" action="{% url 'americano_delete_tournament' tournament.pk %}" class="m-0">
          {% csrf_token %}
          <button type="submit"
                  class="btn btn-sm btn-danger"
                  onclick="return confirm('¬øSeguro que quieres borrar el torneo {{ tournament.name }}? Se eliminar√°n todas las rondas y resultados. Esta acci√≥n no se puede deshacer.');">
            Borrar torneo
          </button>
        </form>
      {% endif %}
      
    </div>
  {% endif %}

{% empty %}
  <p class="text-muted">A√∫n no hay rondas creadas.</p>
{% endfor %}

<!-- New round button for empty tournament -->
{% if can_edit and rounds.count == 0 %}
  <div class="mt-3">
    <a class="btn btn-sm btn-americano-header"
      href="{% url 'americano_new_round' tournament.pk %}">
      Nueva ronda
    </a>
  </div>
{% endif %}

</div>
{% endblock %}
