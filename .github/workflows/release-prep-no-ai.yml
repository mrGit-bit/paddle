name: Release Prep (no-AI)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (X.Y.Z), e.g. 1.3.0"
        required: true
      target_branch:
        description: "Branch to prepare release from (usually develop)"
        required: true
        default: "develop"

permissions:
  contents: write
  pull-requests: write

jobs:
  prep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: Install gh (GitHub CLI)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Prepare release branch
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -e
          BRANCH="chore/release-v${VERSION}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Update CHANGELOG.md (move Unreleased -> version)
        env:
          VERSION: ${{ inputs.version }}
        run: |
          python - <<'PY'
          import re
          from datetime import datetime, timezone
          from pathlib import Path

          path = Path("CHANGELOG.md")
          if not path.exists():
            raise SystemExit("CHANGELOG.md not found at repo root")

          text = path.read_text(encoding="utf-8")

          # Find Unreleased section: from '## [Unreleased]' until next '## ['
          m = re.search(r"^## \[Unreleased\]\s*\n(?P<body>.*?)(?=^## \[|\Z)", text, flags=re.M | re.S)
          if not m:
            raise SystemExit("No '## [Unreleased]' section found in CHANGELOG.md")

          body = m.group("body").strip("\n")
          # If Unreleased is empty (or only whitespace), still create the new section but with placeholder
          if not body.strip():
            body = "- (no notable changes)\n"

          today = datetime.now(timezone.utc).strftime("%Y-%m-%d")
          new_header = f"## [{VERSION}] - {today}\n"
          # Ensure there is at least a short summary area (keep simple placeholder if user didn't write bullets)
          new_section = new_header + body.strip() + "\n\n"

          # Replace Unreleased content with empty section
          unreleased_replacement = "## [Unreleased]\n\n"
          new_text = re.sub(
            r"^## \[Unreleased\]\s*\n.*?(?=^## \[|\Z)",
            unreleased_replacement,
            text,
            flags=re.M | re.S
          )

          # Insert new version section immediately after Unreleased
          new_text = new_text.replace(unreleased_replacement, unreleased_replacement + new_section, 1)

          path.write_text(new_text, encoding="utf-8")
          print(f"Updated CHANGELOG.md: created {new_header.strip()}")
          PY

      - name: Commit changes
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -e
          git add CHANGELOG.md
          if git diff --cached --quiet; then
            echo "No CHANGELOG changes staged. Exiting."
            exit 1
          fi
          git commit -m "version(release): prepare release v${VERSION}"
          git push -u origin "$BRANCH"

      - name: Open PR to target branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          TARGET: ${{ inputs.target_branch }}
        run: |
          set -e
          gh pr create \
            --base "$TARGET" \
            --head "$BRANCH" \
            --title "version(release): prepare release v${VERSION}" \
            --body "Automated release preparation (no-AI).

Checklist:
- [ ] Review CHANGELOG.md section for v${VERSION}
- [ ] Update BACKLOG.md manually if needed
- [ ] CI is green
"
